name: Audit de S√©curit√© Azure Weave
on: [push] # Se lance √† chaque push sur n'importe quelle branche

jobs:
  audit-security:
    runs-on: ubuntu-latest
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Audit de la Base de Donn√©es et R√©seau
        shell: /usr/bin/bash -e
        run: |
          # Variables bas√©es sur tes informations
          RG="weave-team"
          DB_SERVER="weave-db-server"

          echo "üöÄ Lancement de l'audit pour le groupe: $RG"
          echo "------------------------------------------"

          # 1. V√©rification de l'Acc√®s Public (Point critique)
          public_access=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "network.publicNetworkAccess" -o tsv)
          if [ "$public_access" == "Enabled" ]; then
            echo "‚ö†Ô∏è  ALERTE : L'acc√®s public √† la DB est activ√© (Actuellement: $public_access)."
          else
            echo "‚úÖ SUCC√àS : L'acc√®s public est restreint."
          fi

          # 2. V√©rification du chiffrement TLS
          tls_version=$(az postgres flexible-server parameter show --resource-group $RG --server-name $DB_SERVER --name "minimal_tls_version" --query "value" -o tsv)
          echo "üîí Version TLS minimale configur√©e : $tls_version"

          # 3. V√©rification de la version PostgreSQL
          db_version=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "version" -o tsv)
          echo "üêò Version de PostgreSQL : $db_version (Ok)"

          # 4. V√©rification de l'√©tat du stockage
          storage_size=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "storage.storageSizeGb" -o tsv)
          auto_grow=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "storage.autoGrow" -o tsv)
          echo "üíæ Stockage : ${storage_size}GB (Auto-grow: $auto_grow)"
          
          if [ "$auto_grow" == "Disabled" ]; then
            echo "‚ö†Ô∏è  ATTENTION : Le stockage ne s'agrandira pas automatiquement si la DB est pleine."
          fi

          # 5. V√©rification DDoS (si un VNet existe)
          echo "üõ°Ô∏è  V√©rification DDoS..."
          VNET_NAME=$(az network vnet list --resource-group "$RG" --query "[0].name" -o tsv)
          if [ -z "$VNET_NAME" ]; then
            echo "‚ÑπÔ∏è  Note : Aucun VNet d√©tect√©. Vos services utilisent l'IP publique directe."
          else
            status=$(az network vnet show --name "$VNET_NAME" --resource-group "$RG" --query "enableDdosProtection" -o tsv)
            echo "Statut DDoS sur $VNET_NAME : $status"
          fi
