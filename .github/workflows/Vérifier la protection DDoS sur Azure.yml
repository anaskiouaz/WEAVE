name: Audit de S√©curit√© Azure Weave
on: [push]

jobs:
  audit-security:
    runs-on: ubuntu-latest
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Audit de la Base de Donn√©es et R√©seau
        shell: bash
        run: |
          # Variables de ton infrastructure
          RG="weave-team"
          DB_SERVER="weave-db-server"

          echo "üöÄ Lancement de l'audit pour le groupe: $RG"
          echo "------------------------------------------"

          # 1. V√©rification de l'Acc√®s Public
          # R√©cup√®re l'√©tat du r√©seau public pour PostgreSQL
          public_access=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "network.publicNetworkAccess" -o tsv)
          if [ "$public_access" == "Enabled" ]; then
            echo "‚ö†Ô∏è  ALERTE : L'acc√®s public √† la DB est activ√©."
          else
            echo "‚úÖ SUCC√àS : L'acc√®s public est restreint."
          fi

          # 2. V√©rification TLS
          tls_version=$(az postgres flexible-server parameter show --resource-group $RG --server-name $DB_SERVER --name "minimal_tls_version" --query "value" -o tsv)
          echo "üîí Version TLS minimale : $tls_version"

          # 3. V√©rification Stockage (Important car auto-grow est d√©sactiv√© chez toi)
          storage_size=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "storage.storageSizeGb" -o tsv)
          auto_grow=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "storage.autoGrow" -o tsv)
          echo "üíæ Stockage : ${storage_size}GB (Auto-grow: $auto_grow)"
          
          if [ "$auto_grow" == "Disabled" ]; then
            echo "‚ö†Ô∏è  ATTENTION : Le stockage ne s'agrandira pas automatiquement."
          fi

          # 4. V√©rification DDoS
          echo "üõ°Ô∏è  V√©rification DDoS..."
          VNET_NAME=$(az network vnet list --resource-group "$RG" --query "[0].name" -o tsv)
          if [ -z "$VNET_NAME" ]; then
            echo "‚ÑπÔ∏è  Note : Aucun VNet d√©tect√© (Services en IP publique directe)."
          else
            status=$(az network vnet show --name "$VNET_NAME" --resource-group "$RG" --query "enableDdosProtection" -o tsv)
            echo "Statut DDoS sur $VNET_NAME : $status"
          fi
