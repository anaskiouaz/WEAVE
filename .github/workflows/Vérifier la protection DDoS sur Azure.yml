name: Audit de S√©curit√© Azure Weave
on: [push]

jobs:
  audit-security:
    runs-on: ubuntu-latest
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Audit de la Base de Donn√©es (Postgres 17)
        shell: bash
        run: |
          RG="weave-team"
          DB_SERVER="weave-db-server"

          echo "üöÄ Lancement de l'audit pour le groupe: $RG"
          echo "------------------------------------------"

          # 1. V√©rification de l'Acc√®s Public
          public_access=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "network.publicNetworkAccess" -o tsv)
          if [ "$public_access" == "Enabled" ]; then
            echo "‚ö†Ô∏è  ALERTE : L'acc√®s public √† la DB est activ√©. Assurez-vous de restreindre les IPs de pare-feu."
          else
            echo "‚úÖ SUCC√àS : L'acc√®s public est restreint."
          fi

          # 2. V√©rification de l'√©tat du serveur (Postgres 17 g√®re TLS nativement)
          db_status=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "state" -o tsv)
          echo "üìä √âtat du serveur : $db_status"

          # 3. V√©rification Stockage (Point critique : 32Go sans auto-grow)
          storage_info=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "{Size:storage.storageSizeGb, AutoGrow:storage.autoGrow}" -o json)
          echo "üíæ Infos Stockage : $storage_info"
          
          auto_grow=$(echo $storage_info | jq -r '.AutoGrow')
          if [ "$auto_grow" == "Disabled" ]; then
            echo "‚ö†Ô∏è  ATTENTION : Le stockage est bloqu√© √† 32 Go. Pensez √† l'augmenter si vos donn√©es saturent."
          fi

          # 4. V√©rification de la version (Confirmation)
          version=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "version" -o tsv)
          echo "üêò Moteur : PostgreSQL $version"
