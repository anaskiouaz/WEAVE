name: Audit de S√©curit√© Azure Weave (Ultra Complet)
on: [push]

jobs:
  audit-security:
    runs-on: ubuntu-latest
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Audit de l'Infrastructure Weave-Team
        shell: bash
        run: |
          RG="weave-team"
          DB_SERVER="weave-db-server"
          APP_NAME="weave-be-server"

          echo "üöÄ LANCEMENT DE L'AUDIT COMPLET : $RG"
          echo "=========================================="

          echo "üêò SECTION 1 : BASE DE DONN√âES (POSTGRESQL)"
          # 1.1 Acc√®s Public & √âtat
          db_info=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "{State:state, Public:network.publicNetworkAccess, Version:version}" -o json)
          echo "üìä √âtat : $(echo $db_info | jq -r '.State') | Version : $(echo $db_info | jq -r '.Version')"
          
          if [ "$(echo $db_info | jq -r '.Public')" == "Enabled" ]; then
            echo "‚ö†Ô∏è  ALERTE : Acc√®s public activ√©."
            
            # 1.2 Audit d√©taill√© du Pare-feu (Firewall)
            echo "üõ°Ô∏è  V√©rification des r√®gles de Pare-feu :"
            rules=$(az postgres flexible-server firewall-rule list --resource-group $RG --name $DB_SERVER --query "[].{Name:name, Start:startIpAddress, End:endIpAddress}" -o table)
            echo "$rules"
            
            # V√©rification de la r√®gle trop permissive "0.0.0.0" (Allow all Azure services)
            is_azure_open=$(az postgres flexible-server firewall-rule list --resource-group $RG --name $DB_SERVER --query "[?startIpAddress=='0.0.0.0'].name" -o tsv)
            if [ ! -z "$is_azure_open" ]; then
              echo "üî¥ DANGER : La r√®gle '$is_azure_open' autorise TOUS les services Azure mondiaux √† tenter de se connecter."
            fi
          fi

          # 1.3 Audit de la R√©silience (Sauvegardes)
          echo "üíæ V√©rification de la r√©tention des donn√©es :"
          backup_info=$(az postgres flexible-server show --resource-group $RG --name $DB_SERVER --query "backup.{Retention:backupRetentionDays, GeoRedundant:geoRedundantBackup}" -o json)
          echo "R√©tention : $(echo $backup_info | jq -r '.Retention') jours | G√©o-redondance : $(echo $backup_info | jq -r '.GeoRedundant')"

          echo -e "\nüåê SECTION 2 : APPLICATION (APP SERVICE)"
          # 2.1 HTTPS & TLS
          echo "üîí V√©rification de la s√©curit√© HTTPS :"
          app_security=$(az webapp show --resource-group $RG --name $APP_NAME --query "{HttpsOnly:httpsOnly, MinTls:siteConfig.minTlsVersion}" -o json)
          echo "HTTPS Only : $(echo $app_security | jq -r '.HttpsOnly') | TLS Min : $(echo $app_security | jq -r '.MinTls')"
          
          if [ "$(echo $app_security | jq -r '.HttpsOnly')" == "false" ]; then
            echo "‚ö†Ô∏è  ALERTE : L'App Service accepte le HTTP non s√©curis√©."
          fi

          # 2.2 Int√©gration R√©seau
          vnet_int=$(az webapp show --resource-group $RG --name $APP_NAME --query "virtualNetworkSubnetId" -o tsv)
          if [ -z "$vnet_int" ]; then
            echo "‚ÑπÔ∏è  INFO : L'App Service n'est pas isol√© dans un VNet (Acc√®s sortant public)."
          fi

          echo -e "\n------------------------------------------"
          echo "‚úÖ FIN DE L'AUDIT"
