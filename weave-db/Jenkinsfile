// ===== Slack helpers =====
def slackInfo(String msg) {
    slackSend(
        channel: '#weave-ci-db',
        color: '#439FE0', // blue
        message: msg
    )
}

def slackSuccess(String msg) {
    slackSend(
        channel: '#weave-ci-db',
        color: 'good',
        message: msg
    )
}

def slackFailure(String msg) {
    slackSend(
        channel: '#weave-ci-db',
        color: 'danger',
        message: msg
    )
}


// ===== Jira + ScriptRunner helpers =====

// Extract first JIRA key like WEAV-123 from a string (commit message)
String getJiraKey(String text) {
    if (!text) return null

    // Case-insensitive match for PROJECT-123, but normalize to upper-case
    def matcher = text =~ /(?i)\b([A-Z][A-Z0-9]+-\d+)\b/
    return matcher ? matcher[0][1].toUpperCase() : null
}

// Search recent git history for a Jira key (useful on main merge commits)
String findJiraKeyFromHistory(int commitCount = 20) {
    def history = sh(
        script: "git log -n ${commitCount} --pretty=%B",
        returnStdout: true
    ).trim()

    return getJiraKey(history)
}

// Call a ScriptRunner endpoint with an issue key (using Jira PAT)
def notifyJira(String endpoint, String issueKey) {
    // Guard against null / "null" / empty
    if (!issueKey || issueKey.trim().equalsIgnoreCase('null')) {
        echo "No Jira key detected ‚Äî skipping call to ${endpoint}"
        return
    }

    echo "Calling Jira endpoint '${endpoint}' for issue ${issueKey}"

    withCredentials([string(credentialsId: env.JIRA_CRED, variable: 'JIRA_PAT')]) {
        def response = httpRequest(
            httpMode: 'POST',
            url: "${env.JIRA_BASE}/rest/scriptrunner/latest/custom/${endpoint}?issueKey=${issueKey}",
            customHeaders: [
                [name: 'X-Atlassian-Token', value: 'no-check'],
                [name: 'Authorization',    value: "Bearer ${JIRA_PAT}"]
            ],
            validResponseCodes: '100:599',
            consoleLogResponseBody: true
        )

        echo "Jira responded with status ${response.status}"

        if (response.status < 200 || response.status >= 300) {
            // üîî Slack alert on Jira automation failure
            slackFailure("""‚ö†Ô∏è Jira automation *${endpoint}* failed
*Issue*: ${issueKey}
*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*HTTP*: ${response.status}

<${env.BUILD_URL}|Open build in Jenkins>""")
            error "Jira call to '${endpoint}' failed with HTTP ${response.status}"
        }
    }
}

// =======================================================
// ================   MAIN PIPELINE   ====================
// =======================================================

pipeline {
    agent any

    environment {
        // PostgreSQL host/port
        DB_HOST = '192.168.2.60'
        DB_PORT = '5432'

        // DB names
        DEV_DB_NAME  = 'weave_dev'
        PROD_DB_NAME = 'weave_prod'

        // Jira config
        JIRA_BASE = 'https://jira.technovise.fr'
        // Secret text credential containing PAT for user jira-automation
        JIRA_CRED = 'jira-automation-pat'
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    triggers {
        // optional polling in case webhooks are not configured
        pollSCM('H/10 * * * *')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Extract Jira Key from Commit') {
            steps {
                script {
                    def latest = sh(
                        script: "git log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()

                    echo "Latest commit message: ${latest}"

                    def key = getJiraKey(latest)
                    if (!key) {
                        echo "No Jira key in latest commit, searching history..."
                        key = findJiraKeyFromHistory(20)
                    }

                    env.JIRA_KEY = key
                    echo "Detected Jira key (from history): ${env.JIRA_KEY ?: 'NONE'}"
                }
            }
        }

        stage('List migrations') {
            steps {
                sh '''
                    echo "Schema migrations:"
                    ls -1 migrations || echo "  (none)"

                    echo ""
                    echo "Data migrations:"
                    ls -1 data-migrations || echo "  (none)"
                '''
            }
        }

        // ====================== DEV ======================
        stage('Apply migrations to DEV') {
            when { branch 'dev' }
            steps {
                withCredentials([usernamePassword(credentialsId: 'pg-dev-weave',
                                                  usernameVariable: 'PGUSER',
                                                  passwordVariable: 'PGPASS')]) {
                    sh '''
                        set -e

                        echo "Applying SCHEMA migrations to DEV (${DEV_DB_NAME})..."
                        for f in $(ls migrations/*.sql 2>/dev/null | sort); do
                          echo "  -> $f"
                          psql "postgresql://${PGUSER}:${PGPASS}@${DB_HOST}:${DB_PORT}/${DEV_DB_NAME}" \
                               -v ON_ERROR_STOP=1 \
                               -f "$f"
                        done

                        echo "Applying DATA migrations to DEV (${DEV_DB_NAME})..."
                        for f in $(ls data-migrations/*.sql 2>/dev/null | sort); do
                          echo "  -> $f"
                          psql "postgresql://${PGUSER}:${PGPASS}@${DB_HOST}:${DB_PORT}/${DEV_DB_NAME}" \
                               -v ON_ERROR_STOP=1 \
                               -f "$f"
                        done

                        echo "DEV database migrations completed."
                    '''
                }

                // After successful DEV migrations ‚Üí Ready for QA
                script {
                    notifyJira('weaveReadyForQA', env.JIRA_KEY)
                }

                // üîî Slack: DEV DB migrations done
                script {
                    slackSuccess("""‚úÖ DEV DB migrations completed
*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*Database*: ${DEV_DB_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
                }
            }
        }

        // ====================== PROD ======================
        stage('Apply migrations to PROD') {
            when { branch 'main' }
            steps {
                // üîî Slack: waiting for manual approval
                script {
                    slackInfo("""üö¶ *Manual approval required for PROD DB migrations*

*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*Target DB*: ${PROD_DB_NAME}

<${env.BUILD_URL}|Open build in Jenkins to approve or abort>""")
                }

                input message: "Apply database migrations to PRODUCTION (${PROD_DB_NAME})?", ok: "Run migrations"

                withCredentials([usernamePassword(credentialsId: 'pg-prod-weave',
                                                  usernameVariable: 'PGUSER',
                                                  passwordVariable: 'PGPASS')]) {
                    sh '''
                        set -e

                        echo "Applying SCHEMA migrations to PROD (${PROD_DB_NAME})..."
                        for f in $(ls migrations/*.sql 2>/dev/null | sort); do
                          echo "  -> $f"
                          psql "postgresql://${PGUSER}:${PGPASS}@${DB_HOST}:${DB_PORT}/${PROD_DB_NAME}" \
                               -v ON_ERROR_STOP=1 \
                               -f "$f"
                        done

                        echo "Applying DATA migrations to PROD (${PROD_DB_NAME})..."
                        for f in $(ls data-migrations/*.sql 2>/dev/null | sort); do
                          echo "  -> $f"
                          psql "postgresql://${PGUSER}:${PGPASS}@${DB_HOST}:${DB_PORT}/${PROD_DB_NAME}" \
                               -v ON_ERROR_STOP=1 \
                               -f "$f"
                        done

                        echo "PROD database migrations completed."
                    '''
                }

                // After successful PROD migrations ‚Üí Released
                script {
                    notifyJira('weaveReleased', env.JIRA_KEY)
                }

                // üîî Slack: PROD DB migrations done
                script {
                    slackSuccess("""üöÄ PROD DB migrations completed
*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*Database*: ${PROD_DB_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
                }
            }
        }
    }

    post {
        success {
            script {
                slackSuccess("""‚úÖ Weave DB pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} succeeded

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
        failure {
            script {
                slackFailure("""‚ùå Weave DB pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} failed

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
        aborted {
            script {
                slackInfo("""‚ö™ Weave DB pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} was aborted

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
    }
}