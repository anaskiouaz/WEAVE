// ===== Slack helpers =====
def slackInfo(String msg) {
    slackSend(
        channel: '#weave-ci-fe',
        color: '#439FE0', // blue
        message: msg
    )
}

def slackSuccess(String msg) {
    slackSend(
        channel: '#weave-ci-fe',
        color: 'good',
        message: msg
    )
}

def slackFailure(String msg) {
    slackSend(
        channel: '#weave-ci-fe',
        color: 'danger',
        message: msg
    )
}

// ===== Jira + ScriptRunner helpers =====

// Extract first JIRA key like WEAV-123 from a string (commit message)
String getJiraKey(String text) {
    if (!text) return null
    def matcher = text =~ /([A-Z]+-\d+)/
    return matcher ? matcher[0][1] : null
}


// Call a ScriptRunner endpoint with an issue key
def notifyJira(String endpoint, String issueKey) {
    if (!issueKey || issueKey.trim().equalsIgnoreCase('null')) {
        echo "No Jira key detected ‚Äî skipping call to ${endpoint}"
        return
    }

    echo "Calling Jira endpoint '${endpoint}' for issue ${issueKey}"

    // Use Jira Personal Access Token (PAT) via Bearer auth
    withCredentials([string(credentialsId: env.JIRA_CRED, variable: 'JIRA_PAT')]) {
        def response = httpRequest(
            httpMode: 'POST',
            url: "${env.JIRA_BASE}/rest/scriptrunner/latest/custom/${endpoint}?issueKey=${issueKey}",
            // No 'authentication:' here ‚Äì we send Authorization header ourselves
            customHeaders: [
                [name: 'X-Atlassian-Token', value: 'no-check'],
                [name: 'Authorization',    value: "Bearer ${JIRA_PAT}"]
            ],
            // log body and don't fail before we inspect it
            validResponseCodes: '100:599',
            consoleLogResponseBody: true
        )

        echo "Jira responded with status ${response.status}"

        if (response.status < 200 || response.status >= 300) {
            // üîî Slack alert on Jira automation failure
            slackFailure("""‚ö†Ô∏è Jira automation *${endpoint}* failed
*Issue*: ${issueKey}
*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*HTTP*: ${response.status}

<${env.BUILD_URL}|Open build in Jenkins>""")
            error "Jira call to '${endpoint}' failed with HTTP ${response.status}"
        }
    }
}

// Build metadata stored as Groovy variables (not env)
def GIT_COMMIT_HASH = ''
def BUILD_ID_NUMBER = ''

pipeline {
    agent any

    environment {
        BACKEND_HOST = '192.168.10.10'

        DEV_FRONTEND_DIR  = '/var/www/vhosts/technovise.fr/dev-weave.technovise.fr/public'
        PROD_FRONTEND_DIR = '/var/www/vhosts/technovise.fr/weave.technovise.fr/public'

        APP_NAME = 'weave-frontend'

        // üîπ Jira config
        JIRA_BASE = 'https://jira.technovise.fr'
        // Jenkins credential **Kind: Secret text**, value = Jira PAT for user jira-automation
        JIRA_CRED = 'jira-automation-pat'
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    stages {

        /* ----------------------- CHECKOUT ----------------------- */
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        /* ------------- Set build metadata (hash, build id) ------ */
        stage('Set build metadata') {
            steps {
                script {
                    GIT_COMMIT_HASH = sh(
                        returnStdout: true,
                        script: 'git rev-parse --short HEAD'
                    ).trim()

                    BUILD_ID_NUMBER = env.BUILD_NUMBER

                    echo "GIT_COMMIT_HASH = ${GIT_COMMIT_HASH}"
                    echo "BUILD_ID_NUMBER = ${BUILD_ID_NUMBER}"
                }
            }
        }

        /* ---- Extract Jira key from latest commit message ------- */
        stage('Extract Jira Key from Commit') {
            steps {
                script {
                    env.COMMIT_MESSAGE = sh(
                        script: "git log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()

                    echo "Latest commit message: ${env.COMMIT_MESSAGE}"

                    env.JIRA_KEY = getJiraKey(env.COMMIT_MESSAGE)
                    echo "Detected Jira key: ${env.JIRA_KEY ?: 'NONE'}"
                }
            }
        }

        /* ----------------------- INSTALL ------------------------ */
        stage('Install deps') {
            steps {
                sh '''
                    node -v
                    npm -v
                    npm ci
                '''
            }
        }

        /* ----------------------- TEST --------------------------- */
        stage('Tests') {
            steps {
                sh '''
                    echo "Checking if an npm test script exists..."
                    if npm run | grep -q " test"; then
                        npm test
                    else
                        echo "No test script found. Skipping."
                    fi
                '''
            }
        }

        /* ----------------------- BUILD -------------------------- */
        stage('Build') {
            steps {
                sh '''
                    rm -rf dist
                    npm run build
                '''
            }
        }

        /* ----------------------- PACKAGE ------------------------ */
        stage('Package') {
            steps {
                sh '''
                    rm -f weave-frontend.tar.gz
                    tar czf weave-frontend.tar.gz dist
                '''
                archiveArtifacts artifacts: 'weave-frontend.tar.gz', fingerprint: true
            }
        }

        /* ----------------------- DEPLOY DEV --------------------- */
        stage('Deploy to DEV') {
            when { branch 'dev' }
            steps {
                sshagent(credentials: ['plesk-ssh']) {
                    sh """
                        scp weave-frontend.tar.gz technovise.fr_rktcy0uglor@${BACKEND_HOST}:/tmp/weave-frontend.tar.gz

                        ssh technovise.fr_rktcy0uglor@${BACKEND_HOST} '
                            set -e

                            cd ${DEV_FRONTEND_DIR}

                            rm -rf dist
                            tar xzf /tmp/weave-frontend.tar.gz
                            rm -f /tmp/weave-frontend.tar.gz

                            # Update build metadata
                            echo "GIT_COMMIT_HASH=${GIT_COMMIT_HASH}" > build.info
                            echo "BUILD_ID=${BUILD_ID_NUMBER}" >> build.info
                        '
                    """
                }

                // üîπ Notify Jira: DEV deploy success ‚Üí Ready for QA
                script {
                    notifyJira('weaveReadyForQA', env.JIRA_KEY)
                }

                // üîî Slack: DEV deploy done
                script {
                    slackSuccess("""‚úÖ DEV deploy completed for *${env.JOB_NAME}* #${env.BUILD_NUMBER}
*Branch*: ${env.BRANCH_NAME}
*Commit*: ${GIT_COMMIT_HASH}

<${env.BUILD_URL}|Open build in Jenkins>""")
                }
            }
        }

        /* ----------------------- DEPLOY PROD -------------------- */
        stage('Deploy to PROD') {
            when { branch 'main' }
            steps {
                // üîî Slack: waiting for manual approval
                script {
                    slackInfo("""üö¶ *Manual approval required for PROD deploy*

*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*Branch*: ${env.BRANCH_NAME ?: 'main'}
*Target*: weave.technovise.fr

<${env.BUILD_URL}|Open build in Jenkins to approve or abort>""")
                }

                input message: 'Deploy WEAVE Frontend to PRODUCTION (weave.technovise.fr)?', ok: 'Deploy'

                // üîî Slack: approval granted
                script {
                    slackInfo("üßë‚Äç‚úàÔ∏è *PROD deploy approved* for *${env.JOB_NAME}* #${env.BUILD_NUMBER}")
                }

                sshagent(credentials: ['plesk-ssh']) {
                    sh """
                        scp weave-frontend.tar.gz technovise.fr_rktcy0uglor@${BACKEND_HOST}:/tmp/weave-frontend.tar.gz

                        ssh technovise.fr_rktcy0uglor@${BACKEND_HOST} '
                            set -e

                            cd ${PROD_FRONTEND_DIR}

                            rm -rf dist
                            tar xzf /tmp/weave-frontend.tar.gz
                            rm -f /tmp/weave-frontend.tar.gz

                            # Write build metadata
                            echo "GIT_COMMIT_HASH=${GIT_COMMIT_HASH}" > build.info
                            echo "BUILD_ID=${BUILD_ID_NUMBER}" >> build.info
                        '
                    """
                }

                // üîπ Notify Jira: PROD deploy success ‚Üí Released
                script {
                    notifyJira('weaveReleased', env.JIRA_KEY)
                }

                // üîî Slack: PROD deploy done
                script {
                    slackSuccess("""üöÄ *PROD deploy completed* for *${env.JOB_NAME}* #${env.BUILD_NUMBER}
*Branch*: ${env.BRANCH_NAME ?: 'main'}
*Commit*: ${GIT_COMMIT_HASH}
*Target*: weave.technovise.fr

<${env.BUILD_URL}|Open build in Jenkins>""")
                }
            }
        }
    }

    post {
        success {
            script {
                slackSuccess("""‚úÖ Pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} succeeded
*Branch*: ${env.BRANCH_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
        failure {
            script {
                slackFailure("""‚ùå Pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} failed
*Branch*: ${env.BRANCH_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
        aborted {
            script {
                slackInfo("""‚ö™ Pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} was aborted
*Branch*: ${env.BRANCH_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
    }
}