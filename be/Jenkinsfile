
def slackFailure(String msg) {
    slackSend(
        channel: '#weave-ci-be',
        color: 'danger',
        message: msg
    )

    
}


// ===== Jira + ScriptRunner helpers =====

// Extract first JIRA key like WEAV-123 from a string (commit message)
String getJiraKey(String text) {
    if (!text) return null

    // Case-insensitive match for PROJECT-123
    def matcher = text =~ /(?i)\b([A-Z][A-Z0-9]+-\d+)\b/
    return matcher ? matcher[0][1].toUpperCase() : null
}

// Call a ScriptRunner endpoint with an issue key (using Jira PAT)
def notifyJira(String endpoint, String issueKey) {
    // Guard against null OR literal "null" OR empty
    if (!issueKey || issueKey.trim().equalsIgnoreCase('null')) {
        echo "No Jira key detected ‚Äî skipping call to ${endpoint}"
        return
    }

    echo "Calling Jira endpoint '${endpoint}' for issue ${issueKey}"

    withCredentials([string(credentialsId: env.JIRA_CRED, variable: 'JIRA_PAT')]) {
        def response = httpRequest(
            httpMode: 'POST',
            url: "${env.JIRA_BASE}/rest/scriptrunner/latest/custom/${endpoint}?issueKey=${issueKey}",
            customHeaders: [
                [name: 'X-Atlassian-Token', value: 'no-check'],
                [name: 'Authorization',    value: "Bearer ${JIRA_PAT}"]
            ],
            validResponseCodes: '100:599',
            consoleLogResponseBody: true
        )

        echo "Jira responded with status ${response.status}"

        if (response.status < 200 || response.status >= 300) {
            // üîî Slack alert on Jira automation failure
            slackFailure("""‚ö†Ô∏è Jira automation *${endpoint}* failed
*Issue*: ${issueKey}
*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*HTTP*: ${response.status}

<${env.BUILD_URL}|Open build in Jenkins>""")
            error "Jira call to '${endpoint}' failed with HTTP ${response.status}"
        }
    }
}


// Build metadata stored as Groovy variables (not env)
def GIT_COMMIT_HASH = ''
def BUILD_ID_NUMBER = ''

pipeline {
    agent any

    environment {
        // Plesk host
        BACKEND_HOST = '192.168.10.10'

        // Plesk document roots
        DEV_BACKEND_DIR  = '/var/www/vhosts/technovise.fr/dev-api-weave.technovise.fr/httpdocs'
        PROD_BACKEND_DIR = '/var/www/vhosts/technovise.fr/api-weave.technovise.fr/httpdocs'

        APP_NAME = 'weave-backend'

        // Jira config
        JIRA_BASE = 'https://jira.technovise.fr'
        // Jenkins credential: Secret text containing Jira PAT for user jira-automation
        JIRA_CRED = 'jira-automation-pat'
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    triggers {
        // optional if you use Bitbucket webhooks
        pollSCM('H/5 * * * *')
    }

    stages {

        /* ----------------------- CHECKOUT ----------------------- */
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        /* ------------- Set build metadata (hash, build id) ------ */
        stage('Set build metadata') {
            steps {
                script {
                    GIT_COMMIT_HASH = sh(
                        returnStdout: true,
                        script: 'git rev-parse --short HEAD'
                    ).trim()

                    BUILD_ID_NUMBER = env.BUILD_NUMBER

                    echo "GIT_COMMIT_HASH = ${GIT_COMMIT_HASH}"
                    echo "BUILD_ID_NUMBER = ${BUILD_ID_NUMBER}"
                }
            }
        }

        // üîπ Extract Jira key from latest commit message
        stage('Extract Jira Key from Commit') {
            steps {
                script {
                    env.COMMIT_MESSAGE = sh(
                        script: "git log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()

                    echo "Latest commit message: ${env.COMMIT_MESSAGE}"

                    env.JIRA_KEY = getJiraKey(env.COMMIT_MESSAGE)
                    echo "Detected Jira key: ${env.JIRA_KEY ?: 'NONE'}"
                }
            }
        }

        stage('Install deps') {
            steps {
                sh '''
                    node -v
                    npm -v
                    npm ci
                '''
            }
        }

        stage('Tests') {
            steps {
                sh '''
                    echo "Checking if an npm test script exists..."
                    if npm run | grep -q " test"; then
                        echo "Test script found. Running npm test..."
                        npm test
                    else
                        echo "No npm test script defined in package.json. Skipping tests."
                    fi
                '''
            }
        }

        stage('Build') {
            when {
                expression { fileExists('tsconfig.json') || fileExists('webpack.config.js') }
            }
            steps {
                sh 'npm run build'
            }
        }

        stage('Package') {
            steps {
                sh '''
                    rm -f weave-backend.tar.gz
                    tar czf weave-backend.tar.gz \
                        package.json \
                        package-lock.json \
                        src
                '''
                archiveArtifacts artifacts: 'weave-backend.tar.gz', fingerprint: true
            }
        }

        // ===== DEV / STAGING: dev ‚Üí dev-api-weave.technovise.fr =====
        stage('Deploy to DEV') {
            when { branch 'dev' }
            steps {
                sshagent(credentials: ['plesk-ssh']) {
                    sh """
                        # Upload artifact
                        scp weave-backend.tar.gz technovise.fr_rktcy0uglor@${BACKEND_HOST}:/tmp/weave-backend.tar.gz

                        # Deploy on server
                        ssh technovise.fr_rktcy0uglor@${BACKEND_HOST} '
                            set -e

                            cd ${DEV_BACKEND_DIR}

                            # Extract new code
                            tar xzf /tmp/weave-backend.tar.gz
                            rm -f /tmp/weave-backend.tar.gz

                            # Install dependencies
                            npm ci --omit=dev

                            # Rebuild .env.development with fresh build metadata
                            if [ -f .env.development ]; then
                                grep -v "^GIT_COMMIT_HASH=" .env.development | grep -v "^BUILD_ID=" > .env.development.build || true
                            fi
                            echo "GIT_COMMIT_HASH=${GIT_COMMIT_HASH}" >> .env.development.build
                            echo "BUILD_ID=${BUILD_ID_NUMBER}" >> .env.development.build
                            mv .env.development.build .env.development

                            # Restart Node.js (Plesk Passenger)
                            mkdir -p ../tmp
                            touch ../tmp/restart.txt
                        '
                    """
                }

                // Notify Jira: DEV deploy success ‚Üí Ready for QA
                script {
                    notifyJira('weaveReadyForQA', env.JIRA_KEY)
                }

                // üîî Slack: DEV deploy done
                script {
                    slackSuccess("""‚úÖ DEV backend deploy completed for *${env.JOB_NAME}* #${env.BUILD_NUMBER}
*Branch*: ${env.BRANCH_NAME}
*Commit*: ${GIT_COMMIT_HASH}

<${env.BUILD_URL}|Open build in Jenkins>""")
                }
            }
        }

        // ===== PROD: main ‚Üí api-weave.technovise.fr =====
        stage('Deploy to PROD') {
            when { branch 'main' }
            steps {
                // üîî Slack: waiting for manual approval
                script {
                    slackInfo("""üö¶ *Manual approval required for backend PROD deploy*

*Job*: ${env.JOB_NAME}
*Build*: #${env.BUILD_NUMBER}
*Branch*: ${env.BRANCH_NAME ?: 'main'}
*Target*: api-weave.technovise.fr

<${env.BUILD_URL}|Open build in Jenkins to approve or abort>""")
                }

                input message: 'Deploy Weave backend to PRODUCTION (api-weave.technovise.fr)?', ok: 'Deploy'

                // üîî Slack: approval granted
                script {
                    slackInfo("üßë‚Äç‚úàÔ∏è *PROD backend deploy approved* for *${env.JOB_NAME}* #${env.BUILD_NUMBER}")
                }

                sshagent(credentials: ['plesk-ssh']) {
                    sh """
                        # Upload artifact
                        scp weave-backend.tar.gz technovise.fr_rktcy0uglor@${BACKEND_HOST}:/tmp/weave-backend.tar.gz

                        # Deploy on server
                        ssh technovise.fr_rktcy0uglor@${BACKEND_HOST} '
                            set -e

                            cd ${PROD_BACKEND_DIR}

                            # Extract new code
                            tar xzf /tmp/weave-backend.tar.gz
                            rm -f /tmp/weave-backend.tar.gz

                            # Install dependencies
                            npm ci --omit=dev

                            # Rebuild .env.production with fresh build metadata
                            if [ -f .env.production ]; then
                                grep -v "^GIT_COMMIT_HASH=" .env.production | grep -v "^BUILD_ID=" > .env.production.build || true
                            fi
                            echo "GIT_COMMIT_HASH=${GIT_COMMIT_HASH}" >> .env.production.build
                            echo "BUILD_ID=${BUILD_ID_NUMBER}" >> .env.production.build
                            mv .env.production.build .env.production

                            # Restart Node.js (Plesk Passenger)
                            mkdir -p ../tmp
                            touch ../tmp/restart.txt
                        '
                    """
                }

                /// Notify Jira: PROD deploy success ‚Üí Released
                script {
                    notifyJira('weaveReleased', env.JIRA_KEY)
                }

                // üîî Slack: PROD deploy done
                script {
                    slackSuccess("""üöÄ *PROD backend deploy completed* for *${env.JOB_NAME}* #${env.BUILD_NUMBER}
*Branch*: ${env.BRANCH_NAME ?: 'main'}
*Commit*: ${GIT_COMMIT_HASH}
*Target*: api-weave.technovise.fr

<${env.BUILD_URL}|Open build in Jenkins>""")
                }
            }
        }
    }

    post {
        success {
            script {
                slackSuccess("""‚úÖ Backend pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} succeeded
*Branch*: ${env.BRANCH_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
        failure {
            script {
                slackFailure("""‚ùå Backend pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} failed
*Branch*: ${env.BRANCH_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
        aborted {
            script {
                slackInfo("""‚ö™ Backend pipeline *${env.JOB_NAME}* #${env.BUILD_NUMBER} was aborted
*Branch*: ${env.BRANCH_NAME}

<${env.BUILD_URL}|Open build in Jenkins>""")
            }
        }
    }
}
